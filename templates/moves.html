<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moves</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#0066cc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BJJ Tracker">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, sans-serif;
        background: #1a1a1a;
        color: white;
        overflow: hidden;
      }

      /* Hamburger Menu */
      .hamburger {
        position: fixed;
        top: 20px;
        left: 20px;
        width: 30px;
        height: 24px;
        cursor: pointer;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .hamburger span {
        display: block;
        height: 3px;
        background: white;
        border-radius: 3px;
        transition: 0.3s;
      }

      .hamburger.active span:nth-child(1) {
        transform: rotate(45deg) translate(8px, 8px);
      }

      .hamburger.active span:nth-child(2) {
        opacity: 0;
      }

      .hamburger.active span:nth-child(3) {
        transform: rotate(-45deg) translate(7px, -7px);
      }

      /* Sidebar */
      .sidebar {
        position: fixed;
        left: -320px;
        top: 0;
        width: 320px;
        height: 100vh;
        background: #111;
        border-right: 1px solid #333;
        transition: 0.3s;
        overflow-y: auto;
        z-index: 1000;
        padding: 80px 20px 20px 20px;
      }

      .sidebar.open {
        left: 0;
      }

      .sidebar h3 {
        margin-bottom: 20px;
        color: #0066cc;
      }

      .map-list {
        margin-bottom: 30px;
      }

      .map-item {
        background: #222;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 6px;
        cursor: pointer;
        border-left: 3px solid #444;
        transition: 0.2s;
      }

      .map-item:hover {
        background: #2a2a2a;
      }

      .map-item.active {
        border-left-color: #0066cc;
        background: #1a3a5c;
      }

      .map-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .delete-map-btn {
        color: #ff4444;
        font-size: 18px;
        cursor: pointer;
        padding: 0 8px;
        display: none;
      }

      .map-item:hover .delete-map-btn {
        display: block;
      }

      .delete-map-btn:hover {
        color: #ff0000;
      }

      .new-map-form {
        display: flex;
        gap: 8px;
        margin-top: 16px;
      }

      .new-map-form input {
        flex: 1;
        padding: 8px;
        background: #222;
        border: 1px solid #444;
        color: white;
        border-radius: 4px;
        font-size: 13px;
      }

      .new-map-form button {
        padding: 8px 12px;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
      }

      header {
        padding: 20px 20px 20px 70px;
        background: #111;
        border-bottom: 1px solid #333;
        position: relative;
        z-index: 10;
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .header-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      header h2 {
        margin: 0;
      }

      form {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        position: relative;
      }

      #moveInput {
        padding: 8px 12px;
        border: 1px solid #444;
        background: #222;
        color: white;
        border-radius: 4px;
        flex: 1;
        max-width: 300px;
      }

      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        width: 300px;
        background: #222;
        border: 1px solid #444;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 100;
      }

      .autocomplete-dropdown.show {
        display: block;
      }

      .autocomplete-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #333;
      }

      .autocomplete-item:hover {
        background: #333;
      }

      .autocomplete-item.create-new {
        color: #0066cc;
        font-weight: bold;
      }

      button {
        padding: 8px 16px;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background: #0052a3;
      }

      #canvas {
        position: relative;
        width: 100%;
        height: calc(100vh - 140px);
        overflow: hidden;
      }

      .move {
        position: absolute;
        padding: 14px 20px;
        background: #222;
        color: white;
        border: 1px solid #444;
        border-radius: 6px;
        cursor: grab;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
        min-width: 100px;
        min-height: 44px;
      }

      .move:active {
        cursor: grabbing;
      }

      .move-name {
        cursor: pointer;
      }

      .move-name:hover {
        color: #0066cc;
        text-decoration: underline;
      }

      .delete-move-btn {
        color: #ff4444;
        font-size: 16px;
        cursor: pointer;
        padding: 0 4px;
        display: none;
      }

      .move:hover .delete-move-btn {
        display: block;
      }

      .delete-move-btn:hover {
        color: #ff0000;
      }

      a {
        color: #0066cc;
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .nav-button {
        display: inline-block;
        padding: 12px 24px;
        background: white;
        color: #1a1a1a;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        transition: 0.2s;
      }

      .top-nav {
        display: inline-block;
      }

      .nav-button:hover {
        background: #e0e0e0;
        text-decoration: none;
        transform: translateY(-1px);
      }

      #lines-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .connection-line {
        stroke: #0066cc;
        stroke-width: 2;
        fill: none;
        marker-end: url(#arrowhead);
        pointer-events: stroke;
        cursor: pointer;
      }

      .connection-line:hover {
        stroke: #ff4444;
        stroke-width: 3;
      }

      .move.connecting {
        box-shadow: 0 0 10px #0066cc;
      }

      .mode-indicator {
        padding: 8px 12px;
        background: #222;
        border: 1px solid #444;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
      }

      .mode-indicator:hover {
        background: #333;
      }

      .mode-indicator.active {
        background: #0066cc;
        border-color: #0066cc;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        header {
          padding: 12px 12px 12px 55px;
        }

        .header-top {
          flex-direction: column;
          align-items: flex-start;
        }

        .header-controls {
          width: 100%;
          justify-content: space-between;
        }

        header h2 {
          font-size: 16px;
        }

        #moveInput {
          max-width: 150px;
          font-size: 13px;
          padding: 6px 8px;
        }

        button {
          padding: 6px 10px;
          font-size: 13px;
        }

        .sidebar {
          width: 280px;
          left: -280px;
          padding: 70px 15px 15px 15px;
        }

        .sidebar.open {
          left: 0;
        }

        .mode-indicator {
          padding: 6px 8px;
          font-size: 11px;
        }

        .nav-button {
          padding: 6px 10px;
          font-size: 11px;
        }

        .move {
          padding: 8px 12px;
          font-size: 14px;
        }

        #canvas {
          height: calc(100vh - 100px);
        }

        .autocomplete-dropdown {
          width: 180px;
        }
      }
    </style>
</head>
<body>
    <!-- Hamburger Menu -->
    <div class="hamburger" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <!-- Sidebar with Move Maps -->
    <div class="sidebar" id="sidebar">
        <h3>üìç Move Maps</h3>
        <div class="map-list">
            {% for map in maps %}
                <div class="map-item {% if map.id == current_map_id %}active{% endif %}" onclick="switchMap({{ map.id }})">
                    <div class="map-item-header">
                        <span>{{ map.name }}</span>
                        {% if maps|length > 1 %}
                        <span class="delete-map-btn" onclick="deleteMap(event, {{ map.id }})">√ó</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div class="new-map-form">
            <input type="text" id="newMapName" placeholder="New map name">
            <button onclick="createNewMap()">+</button>
        </div>
    </div>

    <header>
      <div class="header-top">
        <h2>{{ current_map_name }} Move Map</h2>
        <div class="header-controls">
          <div class="mode-indicator" id="mode-indicator" onclick="toggleConnectMode()">Drag Mode</div>
          <div class="top-nav">
            <a href="/" class="nav-button">‚Üê Back to Journal</a>
          </div>
        </div>
      </div>
      <form method="POST" onsubmit="return false;" style="position: relative;">
        <input id="moveInput" name="name" placeholder="Enter move name here" required autocomplete="off"
               oninput="showAutocomplete(this.value)">
        <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
        <button type="button" onclick="addMove()">Add Move</button>
      </form>
    </header>

    <div id="canvas">
      <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; opacity: 0.7; pointer-events: none; z-index: 1;">
        <div style="font-size: 14px; color: #aaa;">Hold to delete move</div>
        <div style="font-size: 14px; color: #aaa; margin-top: 4px;">Double click to look into a move</div>
      </div>
      <svg id="lines-layer">
        <defs>
          <marker id="arrowhead" markerWidth="10" markerHeight="10" 
                  refX="9" refY="3" orient="auto">
            <polygon points="0 0, 10 3, 0 6" fill="#0066cc" />
          </marker>
        </defs>
        {% for t in transitions %}
          <line class="connection-line"
                data-from="{{ t.from_move_id }}"
                data-to="{{ t.to_move_id }}" />
        {% endfor %}
      </svg>

      {% for move in moves %}
        <div class="move"
             data-id="{{ move.id }}"
             style="left: {{ move.x }}px; top: {{ move.y }}px;">
          <span class="move-name" ondblclick="openMoveProfile('{{ move.name }}')">{{ move.name }}</span>
          <span class="delete-move-btn" onclick="deleteMove(event, {{ move.id }})" title="Delete move">√ó</span>
        </div>
      {% endfor %}
    </div>

    <script>
        const moveProfiles = {{ move_profiles | tojson }};
        const currentMapId = {{ current_map_id }};

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.querySelector('.hamburger');
            sidebar.classList.toggle('open');
            hamburger.classList.toggle('active');
        }

        // Close sidebar when clicking outside
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.querySelector('.hamburger');
            
            if (sidebar.classList.contains('open') && 
                !sidebar.contains(e.target) && 
                !hamburger.contains(e.target)) {
                sidebar.classList.remove('open');
                hamburger.classList.remove('active');
            }
        });

        function switchMap(mapId) {
            window.location.href = `/moves/${mapId}`;
        }

        function createNewMap() {
            const input = document.getElementById('newMapName');
            const name = input.value.trim();
            
            if (!name) return;
            
            fetch('/create_map', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            }).then(res => res.json())
              .then(data => {
                  window.location.href = `/moves/${data.id}`;
              });
        }

        function deleteMap(event, mapId) {
            event.stopPropagation();
            
            if (!confirm('Delete this map and all its moves?')) return;
            
            fetch('/delete_map', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ map_id: mapId })
            }).then(() => {
                window.location.href = '/moves/1';
            });
        }

        function showAutocomplete(value) {
            const dropdown = document.getElementById('autocompleteDropdown');
            
            if (!value.trim()) {
                dropdown.classList.remove('show');
                return;
            }
            
            const filtered = moveProfiles.filter(name => 
                name.toLowerCase().includes(value.toLowerCase())
            );
            
            let html = '';
            filtered.forEach(name => {
                html += `<div class="autocomplete-item" onclick="selectMove('${name}')">${name}</div>`;
            });
            
            if (!filtered.includes(value)) {
                html += `<div class="autocomplete-item create-new" onclick="selectMove('${value}')">+ Create "${value}"</div>`;
            }
            
            dropdown.innerHTML = html;
            dropdown.classList.add('show');
        }

        function selectMove(name) {
            document.getElementById('moveInput').value = name;
            document.getElementById('autocompleteDropdown').classList.remove('show');
        }

        function addMove() {
            const input = document.getElementById('moveInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/moves/${currentMapId}`;
            
            const nameInput = document.createElement('input');
            nameInput.type = 'hidden';
            nameInput.name = 'name';
            nameInput.value = name;
            
            form.appendChild(nameInput);
            document.body.appendChild(form);
            form.submit();
        }

        function openMoveProfile(moveName) {
            window.open(`/move_profile/${encodeURIComponent(moveName)}`, '_blank', 'width=600,height=700');
        }

        function deleteMove(event, moveId) {
            event.stopPropagation();
            
            if (!confirm('Delete this move?')) return;
            
            fetch('/delete_move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ move_id: moveId })
            }).then(() => {
                location.reload();
            });
        }

        // Close autocomplete when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('form')) {
                document.getElementById('autocompleteDropdown').classList.remove('show');
            }
        });
    </script>

    <script src="{{ url_for('static', filename='drag.js') }}"></script>
</body>
</html>